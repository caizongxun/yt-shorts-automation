# YouTube Shorts 自動化系統 - 架構文檔

## 系統概覽

```
┌─────────────────────────────────────────────────────────────────┐
│                     DAILY PIPELINE ORCHESTRATOR                  │
│                    (daily_pipeline.py)                           │
└────────────┬────────────────────────────┬──────────────────────┘
             │                            │
      ┌──────▼──────┐            ┌────────▼─────────┐
      │   STEP 1    │            │    STEP 2        │
      │   CONTENT   │            │   AUDIO          │
      │   SCRAPER   │            │   GENERATOR      │
      └──────┬──────┘            └────────┬─────────┘
             │ stories               │ audio files
             │ (JSON)                │ (MP3)
             └────────────┬──────────┘
                          │
                    ┌─────▼──────┐
                    │   STEP 3   │
                    │   VIDEO    │
                    │ COMPOSITOR │
                    └─────┬──────┘
                          │ video files
                          │ (MP4, 1080x1920)
                          │
                    ┌─────▼──────────┐
                    │   STEP 4       │
                    │   UPLOADER     │
                    │   SCHEDULER    │
                    └────────────────┘
                          │
                          └─► YouTube Shorts
```

## 核心模組流程

### 1️⃣ ContentScraper (內容爬蟲)

```python
# 輸入：
- Reddit API config (可選)
- LLM config (Ollama)

# 處理：
┌─────────────────────────────────┐
│ 1. 連接 Reddit API              │
│ 2. 搜索熱門 subreddit 貼文      │
│ 3. 過濾最小長度                  │
│ 4. 提取 title + content         │
│ 5. 清理換行符和多餘空格          │
└─────────────────────────────────┘

# 備選方案 (無 Reddit API)：
┌─────────────────────────────────┐
│ 1. 本地啟動 Ollama                │
│ 2. 使用 LLM 生成故事              │
│ 3. 支援 5+ 個不同提示詞            │
│ 4. 返回合成內容                   │
└─────────────────────────────────┘

# 輸出：
[
  {
    "source": "reddit" | "llm",
    "title": "Story Title",
    "content": "Full story text...",
    "subreddit": "AskReddit",
    "timestamp": "2025-01-05T15:00:00"
  },
  ...
]
```

### 2️⃣ AudioGenerator (文字轉語音)

```python
# 輸入：
- Text script (從 ContentScraper)
- Voice choice (en-male, en-female, etc.)
- Rate adjustment (+10%, -5%, etc.)

# 處理流程：
┌────────────────────────────────────────┐
│ 1. 初始化 Edge-TTS (Microsoft Azure)   │
│ 2. 分割長文本 (避免超時)               │
│ 3. 並發生成音頻                         │
│ 4. 合併音頻片段                         │
│ 5. 保存 MP3 + 元數據 JSON              │
└────────────────────────────────────────┘

# 性能：
- 60 秒語音 ≈ 8 秒生成時間
- 100% 免費 (無配額限制)
- 支援 100+ 種語言/方言

# 輸出：
{
  "audio_file": "output/audio/audio_20250105_150000.mp3",
  "duration": 45.2,  # seconds
  "text": "Original text...",
  "voice": "en-US-ChristopherNeural",
  "rate": "+10%"
}
```

### 3️⃣ VideoCompositor (視頻合成)

```python
# 輸入：
- Audio file (MP3)
- Background footage (MP4, 任意長度)
- Background music (可選，MP3)
- Title (用於字幕)

# 處理流程：
┌──────────────────────────────────────────┐
│ STEP A: 音頻分析                          │
│  1. 使用 Whisper 進行語音識別              │
│  2. 提取每個單詞的時間軸                   │
│  3. 精確到 0.1 秒                         │
└──────────────────────────────────────────┘
                    │
┌──────────────────▼──────────────────────┐
│ STEP B: 背景視頻準備                     │
│  1. 隨機選擇背景視頻檔案                  │
│  2. 裁切為 9:16 Shorts 比例               │
│  3. 隨機選擇起始點 (避免重複)             │
│  4. 應用微量色調調整 (randomization)     │
└──────────────────▼──────────────────────┘
                    │
┌──────────────────▼──────────────────────┐
│ STEP C: 字幕生成                         │
│  1. 為每個單詞建立文本剪輯                │
│  2. 設定顏色、大小、陰影                  │
│  3. 根據時間軸排列                       │
│  4. Ken Burns 效果 (可選)                │
└──────────────────▼──────────────────────┘
                    │
┌──────────────────▼──────────────────────┐
│ STEP D: 背景音樂混音                     │
│  1. 加載背景音樂 (5% 音量)               │
│  2. 與主要語音合併                       │
│  3. 歸一化音頻電平                       │
└──────────────────▼──────────────────────┘
                    │
┌──────────────────▼──────────────────────┐
│ STEP E: 最終合成                         │
│  1. CompositeVideoClip (層級合成)        │
│  2. H.264 編碼 (YouTube 兼容)            │
│  3. 30 FPS, 1080x1920 解析度             │
│  4. 生成元數據 JSON                      │
└──────────────────▼──────────────────────┘

# 隨機化機制 (避免演算法檢測重複內容)：
- 背景視頻隨機起始點: ±30% 變化
- 字幕顏色: 3-5 種隨機組合
- 字幕大小: ±10% 變化
- 色調調整: -5% ~ +5% 亮度
- 特效疊層: 50% 概率添加

# 輸出：
{
  "video_file": "output/videos/short_20250105_150000.mp4",
  "duration": 45,  # seconds
  "resolution": "1080x1920",
  "fps": 30,
  "file_size_mb": 28.5,
  "audio_source": "...",
  "background": "...",
  "timestamp": "2025-01-05T15:00:00"
}
```

### 4️⃣ YouTubeUploader (上傳排程)

```python
# 輸入：
- Video files (MP4)
- Metadata (title, description, tags)
- Upload schedule

# 處理流程：
┌─────────────────────────────────────────┐
│ 方案 A: Selenium 自動化上傳               │
│  1. 啟動 Chrome WebDriver                │
│  2. 打開 YouTube Studio                  │
│  3. 上傳視頻檔案                         │
│  4. 填寫標題/描述/標籤                   │
│  5. 選擇 Shorts 格式                     │
│  6. 定時發布 (避免同時上傳)              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 方案 B: 手動上傳 (更安全)                │
│  1. 生成 upload_schedule.json            │
│  2. 用戶手動上傳 (避免被演算法標記)      │
│  3. 按照排程時間發布                     │
└─────────────────────────────────────────┘

# 反爬蟲機制：
├─ 上傳間隔: 45-90 分鐘隨機
├─ 發布時間: 09:00-21:00 隨機分散
├─ 標題變化: 每次不同描述
├─ 標籤組合: 5+ 個標籤隨機選擇
└─ 元數據記錄: 完整審計日誌

# 輸出：
{
  "upload_schedule.json": [
    {
      "video": "short_001.mp4",
      "upload_time": "2025-01-06T09:30:00",
      "title": "Amazing Fact #Shorts",
      "tags": ["Shorts", "Facts", "Viral"]
    },
    ...
  ]
}
```

## 數據流圖

```
Reddit/LLM
    ↓
    │ stories (JSON)
    ↓
┌─────────────────┐
│ ContentScraper  │
└────────┬────────┘
         │
         │ scripts (list[str])
         ↓
┌─────────────────┐
│ AudioGenerator  │
│  (Edge-TTS)     │
└────────┬────────┘
         │
         │ audio_files (list[mp3])
         ↓
┌─────────────────────────────────────┐
│      VideoCompositor                │
│  ┌────────────────────────────────┐ │
│  │ 1. Whisper (語音識別)           │ │
│  │ 2. 背景視頻選擇 + 裁切          │ │
│  │ 3. 字幕生成 (MoviePy)          │ │
│  │ 4. 音頻混音                     │ │
│  │ 5. FFmpeg 編碼                  │ │
│  └────────────────────────────────┘ │
└────────┬──────────────────────────┘
         │
         │ video_files (list[mp4, 1080x1920])
         ↓
┌──────────────────────┐
│  UploadScheduler     │
│  - 生成排程 JSON      │
│  - Selenium 上傳      │
└──────────┬───────────┘
           │
           ↓
      YouTube Shorts
```

## 配置層級結構

```
configs/
├── reddit_config.json        # Reddit API 連接設定
│   ├── client_id
│   ├── client_secret
│   ├── subreddits: ["AskReddit", "NoSleep"]
│   └── time_filter: "day"
│
├── youtube_config.json       # YouTube 上傳設定
│   ├── upload_enabled: true
│   ├── schedule_mode: "random" | "fixed"
│   └── min_interval_minutes: 45
│
├── content_config.json       # 內容生成設定
│   ├── voice: "en-male"
│   ├── rate: "+10%"
│   ├── randomization_enabled: true
│   └── effects_level: "medium"
│
└── youtube_client_secret.json # OAuth 認證 (Git 忽略)
```

## 安全 & 效率考量

### 避免演算法檢測

| 風險 | 緩解策略 |
|------|----------|
| 重複內容 | ✅ 隨機背景、字幕、特效 |
| 機器人上傳 | ✅ 分散發布、隨機時間間隔 |
| 低品質 | ✅ Whisper 字幕、高清音頻 |
| 版權侵害 | ✅ Reddit 原創內容、免版權音樂 |
| 過度產量 | ✅ 每日 3 部、兩部間隔 45-90 分 |

### 成本分析

| 組件 | 成本 | 備註 |
|------|------|------|
| Edge-TTS | \\$0 | Microsoft 免費服務 |
| MoviePy | \\$0 | 開源 |
| FFmpeg | \\$0 | 開源 |
| Whisper | \\$0 | OpenAI 開源模型 |
| YouTube | \\$0 | 免費平台 |
| **GPU 電費** | \\$5-15/月 | 可選，加速圖片生成 |
| **總成本** | **\\$0-15/月** | ✅ 完全可承受 |

### 性能指標

```
速度基準 (單個 60 秒 Shorts)：

┌─────────────────┬────────┬────────┐
│ 操作              │ CPU    │ GPU    │
├─────────────────┼────────┼────────┤
│ 語音識別 (Whisper) │ ~30s   │ ~8s    │
│ 字幕生成         │ ~15s   │ ~3s    │
│ 視頻編碼 (H.264)  │ ~120s  │ ~45s   │
│ 音頻混音         │ ~5s    │ ~2s    │
├─────────────────┼────────┼────────┤
│ **總耗時**       │ **170s** │ **58s** |
│ **(2.8 分鐘)**  │        │ **(1 分)** |
└─────────────────┴────────┴────────┘

3 個 Shorts 生產時間：
- CPU only: ~9 分鐘
- GPU: ~3 分鐘
```

## 擴展性設計

```
未來可能的增強：

1. 多語言支持
   └─ 同時生成 EN/ZH/JA/KO 版本

2. 智能標籤推薦
   └─ 使用 NLP 從內容提取關鍵詞

3. A/B 測試框架
   └─ 對比不同風格、背景、標籤的效果

4. 即時分析儀表板
   └─ 顯示觀看數、互動率、迴圈率

5. 多平台發布
   └─ TikTok / Instagram Reels / 抖音 同步

6. AI 故事生成改進
   └─ 使用 GPT-4o / Claude 3.5 Sonnet

7. 自定義背景庫管理
   └─ Web UI 上傳 + 元數據標記
```

## 部署選項

```
┌─────────────────────────────────┐
│ 選項 1: 本地電腦 (推薦)           │
├─────────────────────────────────┤
│ ✅ 完全控制                       │
│ ✅ 無延遲                         │
│ ✅ GPU 加速可用                  │
│ ❌ 需要 24/7 開機                │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 選項 2: Docker (推薦用於雲端)    │
├─────────────────────────────────┤
│ ✅ 完全隔離環境                   │
│ ✅ 易於版本管理                   │
│ ✅ 支援 Heroku/Railway/Replit   │
│ ✅ 無需本地 FFmpeg 設定          │
│ ❌ 冷啟動時間: ~30 秒            │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 選項 3: GitHub Actions (CI/CD)  │
├─────────────────────────────────┤
│ ✅ 完全免費                       │
│ ✅ 無服務器管理                   │
│ ✅ Git 原生集成                  │
│ ❌ 每月 2,000 分鐘限制           │
│ ❌ GPU 不可用                    │
└─────────────────────────────────┘
```

---

**最後更新**: 2025-01-05  
**版本**: 1.0.0  
**狀態**: 生產就緒 ✅
